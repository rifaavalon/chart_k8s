name: Deploy to Development (Working Version)

# This is a WORKING version that addresses the issues in the original workflow
# To use:
# 1. Configure S3 backend in terraform/main.tf
# 2. Set GitHub Secrets (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, DD_API_KEY, SSH_PRIVATE_KEY)
# 3. Rename this file to deploy-dev-working.yml

on:
  workflow_dispatch:  # Manual trigger only

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0
  ENVIRONMENT: dev

jobs:
  deploy-all:
    name: Deploy Infrastructure and Datadog Agents
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false  # Important: allows us to use terraform output

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          # Initialize with backend config
          terraform init \
            -backend-config="bucket=your-terraform-state-bucket" \
            -backend-config="key=datadog-agent/dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var-file=environments/dev/terraform.tfvars \
            -var="datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply tfplan

      - name: Get Terraform Outputs
        id: tf_outputs
        working-directory: ./terraform
        run: |
          # Get instance IPs as JSON array
          INSTANCE_IPS=$(terraform output -json instance_private_ips)
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT

          # Get ALB DNS
          ALB_DNS=$(terraform output -raw alb_dns_name)
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT

          echo "Deployed infrastructure:"
          echo "ALB: $ALB_DNS"
          echo "Instances: $INSTANCE_IPS"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/datadog-demo-key.pem
          chmod 600 ~/.ssh/datadog-demo-key.pem

          # Disable strict host key checking for demo
          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF

      - name: Generate Dynamic Ansible Inventory
        working-directory: ./ansible
        run: |
          # Create dynamic inventory from Terraform outputs
          cat > inventory/dynamic.ini <<EOF
          [dev_servers]
          EOF

          # Parse JSON and add each host
          echo '${{ steps.tf_outputs.outputs.instance_ips }}' | jq -r '.[]' | \
          awk '{print "dev-instance-"NR" ansible_host="$1}' >> inventory/dynamic.ini

          # Add group vars
          cat >> inventory/dynamic.ini <<EOF

          [dev_servers:vars]
          environment=dev
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/datadog-demo-key.pem
          ansible_python_interpreter=/usr/bin/python3
          EOF

          echo "Generated inventory:"
          cat inventory/dynamic.ini

      - name: Wait for EC2 instances to be ready
        run: |
          echo "Waiting for instances to initialize..."
          sleep 90

      - name: Test Ansible connectivity
        working-directory: ./ansible
        run: |
          ansible all -i inventory/dynamic.ini -m ping
        continue-on-error: true

      - name: Deploy Datadog Agent
        working-directory: ./ansible
        run: |
          ansible-playbook \
            -i inventory/dynamic.ini \
            playbooks/deploy-datadog.yml \
            -v
        env:
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          DD_SITE: datadoghq.com
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Verify Agent Deployment
        working-directory: ./ansible
        run: |
          ansible all \
            -i inventory/dynamic.ini \
            -m shell \
            -a "sudo datadog-agent status" \
            --become
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** dev" >> $GITHUB_STEP_SUMMARY
          echo "**Load Balancer:** http://${{ steps.tf_outputs.outputs.alb_dns }}" >> $GITHUB_STEP_SUMMARY
          echo "**Instances:** $(echo '${{ steps.tf_outputs.outputs.instance_ips }}' | jq -r 'length')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Datadog UI: https://app.datadoghq.com/infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "2. Filter by tag: \`env:dev\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify metrics are flowing" >> $GITHUB_STEP_SUMMARY
